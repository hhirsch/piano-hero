(function(e){function t(t){for(var n,o,r=t[0],l=t[1],c=t[2],u=0,f=[];u<r.length;u++)o=r[u],Object.prototype.hasOwnProperty.call(s,o)&&s[o]&&f.push(s[o][0]),s[o]=0;for(n in l)Object.prototype.hasOwnProperty.call(l,n)&&(e[n]=l[n]);d&&d(t);while(f.length)f.shift()();return a.push.apply(a,c||[]),i()}function i(){for(var e,t=0;t<a.length;t++){for(var i=a[t],n=!0,r=1;r<i.length;r++){var l=i[r];0!==s[l]&&(n=!1)}n&&(a.splice(t--,1),e=o(o.s=i[0]))}return e}var n={},s={app:0},a=[];function o(t){if(n[t])return n[t].exports;var i=n[t]={i:t,l:!1,exports:{}};return e[t].call(i.exports,i,i.exports,o),i.l=!0,i.exports}o.m=e,o.c=n,o.d=function(e,t,i){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},o.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(o.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(i,n,function(t){return e[t]}.bind(null,n));return i},o.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="/apps/piano-hero/";var r=window["webpackJsonp"]=window["webpackJsonp"]||[],l=r.push.bind(r);r.push=t,r=r.slice();for(var c=0;c<r.length;c++)t(r[c]);var d=l;a.push([0,"chunk-vendors"]),i()})({0:function(e,t,i){e.exports=i("56d7")},"139f":function(e,t,i){"use strict";var n=i("d205"),s=i.n(n);s.a},"56d7":function(e,t,i){"use strict";i.r(t);i("e260"),i("e6cf"),i("cca6"),i("a79d");var n=i("2b0e"),s=i("289d"),a=(i("5abe"),function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{attrs:{id:"app"}},[i("MainView")],1)}),o=[],r=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("div",{staticClass:"main columns is-gapless"},[i("div",{staticClass:"menu column is-narrow"},[i("div",{staticClass:"title is-2"},[e._v("Piano Hero")]),i("div",{staticClass:"songName"},[e._v(e._s(e.midiFile?e.midiFile.songName:""))]),i("b-field",{style:{"padding-left":"20px","padding-right":"20px"},attrs:{label:"Speed",horizontal:!0}},[i("b-slider",{attrs:{type:"is-primary",size:"is-large",min:.25,max:2,value:1,step:.25,ticks:""},model:{value:e.songSpeed,callback:function(t){e.songSpeed=t},expression:"songSpeed"}})],1),i("b-field",{style:{"padding-left":"20px","padding-right":"20px"},attrs:{label:"Pianola",horizontal:!0}},[i("b-switch",{attrs:{rounded:!1,type:"is-primary"},model:{value:e.inPianolaMode,callback:function(t){e.inPianolaMode=t},expression:"inPianolaMode"}})],1),i("b-field",{style:{"padding-left":"20px","padding-right":"20px"},attrs:{label:"MIDI Device",horizontal:!0}},[i("b-dropdown",{attrs:{disabled:0===e.midiDevices.devices.length,"aria-role":"list"},scopedSlots:e._u([{key:"trigger",fn:function(t){var n=t.active;return i("button",{staticClass:"button is-primary"},[i("span",[e._v(e._s(null!==e.midiDeviceSelected?e.midiDeviceSelected:"Select a device"))]),i("b-icon",{attrs:{icon:n?"menu-up":"menu-down"}})],1)}}]),model:{value:e.midiDeviceSelected,callback:function(t){e.midiDeviceSelected=t},expression:"midiDeviceSelected"}},e._l(e.midiDevices.devices,(function(t){return i("b-dropdown-item",{key:t.id,attrs:{value:t.name,"aria-role":"listitem"}},[e._v(" "+e._s(t.name)+" ")])})),1)],1),i("b-field",{staticClass:"file"},[i("b-upload",{on:{input:e.loadMidiFile}},[i("a",{staticClass:"button is-primary"},[i("span",[e._v("Load Song")])])])],1),i("button",{staticClass:"button is-primary",on:{click:e.loadFurElise}},[i("span",[e._v("Load Fur Elise")])]),i("div",{staticClass:"buttons"},[i("b-button",{attrs:{type:"is-primary",size:"is-large",disabled:!e.midiFile||2===e.gameState||3===e.gameState},on:{click:e.playSong}},[e._v(" ▶ ")]),i("b-button",{attrs:{type:"is-primary",size:"is-large",disabled:!e.midiFile||1===e.gameState||4===e.gameState},on:{click:e.pauseSong}},[e._v(" ❚❚ ")]),i("b-button",{attrs:{type:"is-primary",size:"is-large",disabled:!e.midiFile||1===e.gameState||4===e.gameState},on:{click:e.stopSong}},[e._v(" ◼ ")])],1)],1),i("div",{staticClass:"content column"},[i("div",{staticClass:"columns is-gapless",style:{height:"calc(100% - 200px)"}},[i("div",{ref:"notesColumns",staticClass:"notesColumns column"},[i("div",{staticClass:"columns is-centered is-gapless"},e._l(e.notesColumns,(function(t,n){return i("div",{key:"notesColumn_"+n,class:{notesColumn:!t.isNarrow,narrowNotesColumn:t.isNarrow},style:{"margin-left":e.getMarginLeftNotesColumn(n)}},[e._l(t.visibleNotes,(function(t,s){return i("div",{key:"note_"+n+"_"+s,staticClass:"note",style:{top:e.getScreenYPosByTime(t)}})})),i("div",{staticClass:"dropArea"})],2)})),0)])]),i("div",{staticClass:"keyboard columns is-centered is-gapless"},e._l(e.keys,(function(t,n){return i("div",{key:t[0]+t[1],class:{whiteKey:e.isWhiteKey(t[0]),blackKey:!e.isWhiteKey(t[0]),pressed:e.isKeyPressed(t[0],t[1])},style:{"margin-left":e.getMarginLeftNotesColumn(n)},on:{mousedown:function(i){return e.playNote(t[0],t[1])}}},[i("div",{staticClass:"keySign"},[e._v(e._s(e.getKeySign(t[0],t[1])))])])})),0)])])},l=[],c=(i("99af"),i("c975"),i("ace4"),i("d3b7"),i("5cc6"),i("9a8c"),i("a975"),i("735e"),i("c1ac"),i("d139"),i("3a7b"),i("d5d6"),i("82f8"),i("e91f"),i("60bd"),i("5f96"),i("3280"),i("3fcc"),i("ca91"),i("25a1"),i("cd26"),i("3c5d"),i("2954"),i("649e"),i("219c"),i("170b"),i("b39a"),i("72f7"),i("b85c")),d=(i("b0c0"),i("ddb0"),i("d4ec")),u=i("bee2"),f=144,h=128,p=function(){function e(t,i){if(Object(d["a"])(this,e),this.enabled=!1,this.devices=[],this.noteOnCallback=t,this.noteOffCallback=i,navigator.requestMIDIAccess){this.enabled=!0;var n=this;navigator.requestMIDIAccess().then((function(e){var t,i=Object(c["a"])(e.inputs.values());try{for(i.s();!(t=i.n()).done;){var s=t.value;n.devices.push({id:s.id,name:s.name}),s.onmidimessage=n.onMidiMessage.bind(n)}}catch(a){i.e(a)}finally{i.f()}}))}}return Object(u["a"])(e,[{key:"onMidiMessage",value:function(e){e.data[0]===f?this.noteOnCallback(e.target.name,e.data[1]):e.data[0]===h&&this.noteOffCallback(e.target.name,e.data[1])}}]),e}(),v=(i("fb6a"),i("498a"),function(){function e(t){Object(d["a"])(this,e),this.tempo=5e5,this.songName="",this.parseFile(t)}return Object(u["a"])(e,[{key:"parseFile",value:function(e){var t=0,i=new TextDecoder,n=function(n){var s=i.decode(e.slice(t,t+n));return t+=n,s},s=function(i){i=i||1;for(var n=0,s=0;s<i;++s)n=(n<<8)+e[t+s];return t+=i,n},a=function(){var i=e[t++];if(128&i){i&=127;var n=0;do{n=e[t++],i=(i<<7)+(127&n)}while(128&n)}return i};if("Mthd"!==n(4)&&6!==s(4))return null;this.formatType=s(2),this.numberOfTracks=s(2),this.events=[];var o=s(2),r=32767&o;this.ticksPerBeat=r;for(var l=1,c=0;c<this.numberOfTracks;++c){if("MTrk"!==n(4))return null;s(4);var d=!1,u=0;while(!d){u+=a();var f=this.tempo*u*l/r/1e6,h=s();if(255===h){var p=s();switch(p){case 1:n(a());break;case 3:var v=n(a()).trim();v&&(this.songName=v);break;case 47:a(),d=!0;break;case 81:this.tempo=s(a());break;case 88:a();var m=s(),y=s();s(2),l=m/Math.pow(2,y);break;case 89:a(),s(2);break}}else{var b=h>>4;switch(b){case 8:s(2);break;case 9:this.events.push({time:f,noteNumber:s(),velocity:s()});break;case 11:s(2);break;case 12:s();break;default:console.log("event: ".concat(b," not supported"));break}}}}this.events.sort()}}]),e}()),m=i("d7af"),y=i.n(m),b=22,g=38,w=5,k=2,N=.3,C=36,S=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],O={C:261.63,"C#":277.18,D:293.66,"D#":311.13,E:329.63,F:349.23,"F#":369.99,G:392,"G#":415.3,A:440,"A#":466.16,B:493.88},M={Q:["A",2],W:["B",2],E:["C",3],R:["D",3],T:["E",3],Y:["F",3],U:["G",3],I:["A",3],O:["B",3],8:["G#",3],Z:["C",4],X:["D",4],C:["E",4],V:["F",4],B:["G",4],N:["A",4],M:["B",4],",":["C",5],".":["D",5],"-":["E",5],H:["G#",4],L:["C#",5],"Ñ":["D#",5]},x=3,D={idle:1,countdown:2,playing:3,paused:4},_={name:"Keyboard",data:function(){for(var e=2,t=[],i=0;i<4;++i){var n,s=Object(c["a"])(S);try{for(s.s();!(n=s.n()).done;){var a=n.value;t.push([a,e])}}catch(u){s.e(u)}finally{s.f()}++e}for(var o=[],r=0,l=t;r<l.length;r++){var d=l[r];o.push({isNarrow:!this.isWhiteKey(d[0]),notes:[],visibleNotes:[],startNotesIdx:0})}return{keys:t,keysPressed:{},notesColumns:o,prevGameState:null,gameState:D.idle,midiFile:null,midiDevices:new p(this.onDeviceKeyDown,this.onDeviceKeyUp),midiDeviceSelected:null,songSpeed:1,inPianolaMode:!1,stats:{perfect:0,good:0,bad:0}}},created:function(){window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),this.start=Date.now(),this.playTime=0,this.prevPlayTime=0,this.animFrameId=window.requestAnimationFrame(this.tick),this.$buefy.dialog.alert({title:"Welcome!",message:"Piano Hero enables you to play the piano freely or following a pattern. It´s just an experiment, so probably it contains some bugs.",onConfirm:this.onWelcomeDialogClosed})},destroyed:function(){this.animFrameId&&window.cancelAnimationFrame(this.animFrameId),window.removeEventListener("keyup",this.onKeyUp),window.removeEventListener("keydown",this.onKeyDown)},methods:{tick:function(){var e=this,t=Date.now(),i=(t-this.start)/1e3*this.songSpeed;switch(this.start=t,this.gameState){case D.countdown:this.computeNotesState(),this.playTime+=i,this.timer-=i,this.timer<=0&&this.setGameState(D.playing);break;case D.playing:this.computeNotesState(),this.computeMissingNotes(),this.inPianolaMode&&function(){var t,i=e,n=Object(c["a"])(e.notesColumns);try{for(n.s();!(t=n.n()).done;){var s,a=t.value,o=Object(c["a"])(a.notes);try{var r=function(){var t=s.value;e.playTime>=t.time&&t.time>e.prevPlayTime&&(e.onNoteOn(t.note,t.octave),setTimeout((function(){return i.onNoteOff(t.note,t.octave)}),200))};for(o.s();!(s=o.n()).done;)r()}catch(l){o.e(l)}finally{o.f()}}}catch(l){n.e(l)}finally{n.f()}}(),this.prevPlayTime=this.playTime,this.playTime+=i,this.playTime>this.lastNoteTime+N&&(this.stopSong(),this.inPianolaMode||this.$buefy.dialog.alert({title:"Game Over",message:"Notes - Perfect: ".concat(this.stats.perfect," | Good: ").concat(this.stats.good," | Bad: ").concat(this.stats.bad)}));break}this.animFrameId=window.requestAnimationFrame(this.tick)},initAudio:function(){this.audioContext=new window.AudioContext;var e=this;this.audioContext.audioWorklet.addModule(y.a).then((function(){e.synthWorkletNode=new AudioWorkletNode(e.audioContext,"synth-processor",{numberOfInputs:0}),e.synthWorkletNode.connect(e.audioContext.destination)}))},isWhiteKey:function(e){return 1===e.length},isKeyPressed:function(e,t){return this.keysPressed[this.getNoteId(e,t)]},playNote:function(e,t){if(this.synthWorkletNode){var i=O[e]*Math.pow(2,t-4);this.synthWorkletNode.port.postMessage("playNote:".concat(i))}},onKeyDown:function(e){var t=e.key.toUpperCase();if(t in M){var i=M[t];this.onNoteOn(i[0],i[1])}},onKeyUp:function(e){var t=e.key.toUpperCase();if(t in M){var i=M[t];this.onNoteOff(i[0],i[1])}},onDeviceKeyDown:function(e,t){if(e===this.midiDeviceSelected){var i=this.convertMidiNote(t);this.onNoteOn(i.note,i.octave)}},onDeviceKeyUp:function(e,t){if(e===this.midiDeviceSelected){var i=this.convertMidiNote(t);this.onNoteOff(i.note,i.octave)}},onNoteOn:function(e,t){var i=this.getNoteId(e,t);if(!this.keysPressed[i]&&(this.playNote(e,t),n["a"].set(this.keysPressed,i,!0),this.gameState===D.playing&&!this.inPianolaMode)){var s,a=(t-k)*S.length+S.indexOf(e),o=Object(c["a"])(this.notesColumns[a].notes);try{for(o.s();!(s=o.n()).done;){var r=s.value;if(!r.processed){var l=Math.abs(r.time-this.playTime);if(l<=.5){r.processed=!0,l<.1?++this.stats.perfect:++this.stats.good;break}}}}catch(d){o.e(d)}finally{o.f()}}},onNoteOff:function(e,t){n["a"].set(this.keysPressed,this.getNoteId(e,t),!1)},convertMidiNote:function(e){var t=e-C,i=k+Math.floor(t/12);i<k?i=k:i>5&&(i=5);var n=t-12*(i-k);return{note:S[n],noteIdx:n,octave:i}},onMidiFileLoaded:function(e){this.midiFile=new v(e),this.lastNoteTime=0;var t,i=Object(c["a"])(this.notesColumns);try{for(i.s();!(t=i.n()).done;){var s=t.value;s.notes=[],s.startNotesIdx=0,n["a"].set(s,"visibleNotes",[])}}catch(f){i.e(f)}finally{i.f()}var a,o=Object(c["a"])(this.midiFile.events);try{for(o.s();!(a=o.n()).done;){var r=a.value,l=this.convertMidiNote(r.noteNumber),d=l.noteIdx+12*(l.octave-k);d>=this.notesColumns.length?d=this.notesColumns.length-1:d<0&&(d=0);var u=r.time+3;u>this.lastNoteTime&&(this.lastNoteTime=u),this.notesColumns[d].notes.push({note:l.note,octave:l.octave,time:r.time+3,processed:!1})}}catch(f){o.e(f)}finally{o.f()}},loadFurElise:function(){this.stopSong();var e=this,t=new XMLHttpRequest,i="/apps/piano-hero/static/beethoven_fur_elise.mid";t.open("GET",i,!0),t.responseType="arraybuffer",t.onload=function(){t.response&&e.onMidiFileLoaded(new Uint8Array(t.response))},t.send(null)},loadMidiFile:function(e){this.stopSong();var t=new window.FileReader,i=this;t.onload=function(e){e.target.readyState===FileReader.DONE&&i.onMidiFileLoaded(new Uint8Array(e.target.result))},t.readAsArrayBuffer(e)},onWelcomeDialogClosed:function(){this.initAudio()},setGameState:function(e){switch(this.prevGameState=this.gameState,this.gameState=e,e){case D.idle:var t,i=Object(c["a"])(this.notesColumns);try{for(i.s();!(t=i.n()).done;){var n=t.value;n.visibleNotes=[]}}catch(u){i.e(u)}finally{i.f()}break;case D.countdown:this.timer=x,this.playTime=0,this.stats={perfect:0,good:0,bad:0};var s,a=Object(c["a"])(this.notesColumns);try{for(a.s();!(s=a.n()).done;){var o=s.value;o.startNotesIdx=0;var r,l=Object(c["a"])(o.notes);try{for(l.s();!(r=l.n()).done;){var d=r.value;d.processed=!1}}catch(u){l.e(u)}finally{l.f()}}}catch(u){a.e(u)}finally{a.f()}break}},getKeySign:function(e,t){for(var i in M){var n=M[i];if(n[0]===e&&n[1]===t)return i}return""},getNoteId:function(e,t){return"".concat(e).concat(t)},getScreenYPosByTime:function(e){return"".concat((1-(e-this.playTime)/w)*this.$refs.notesColumns.clientHeight-g,"px")},getMarginLeftNotesColumn:function(e){if(0===e)return"0px";var t=this.notesColumns[e],i=this.notesColumns[e-1];return t.isNarrow||i.isNarrow?"".concat(-b/2,"px"):"0px"},computeMissingNotes:function(){if(!this.inPianolaMode){var e,t=Object(c["a"])(this.notesColumns);try{for(t.s();!(e=t.n()).done;){var i,n=e.value,s=Object(c["a"])(n.notes);try{for(s.s();!(i=s.n()).done;){var a=i.value;a.processed||a.time<this.playTime-N&&(++this.stats.bad,a.processed=!0)}}catch(o){s.e(o)}finally{s.f()}}}catch(o){t.e(o)}finally{t.f()}}},computeNotesState:function(){var e,t=this.playTime+w,i=Object(c["a"])(this.notesColumns);try{for(i.s();!(e=i.n()).done;){var n=e.value;n.visibleNotes=[];var s=n.startNotesIdx;while(s<n.notes.length){var a=n.notes[s].time;if(a>=this.playTime){if(!(a<=t))break;n.notes[s].processed||n.visibleNotes.push(a)}else s>n.startNotesIdx&&(n.startNotesIdx=s);++s}}}catch(o){i.e(o)}finally{i.f()}},playSong:function(){switch(this.prevGameState){case D.idle:case D.countdown:this.setGameState(D.countdown);break;default:this.setGameState(D.playing);break}},pauseSong:function(){this.setGameState(D.paused)},stopSong:function(){this.setGameState(D.idle),this.prevGameState=D.idle}}},F=_,T=(i("139f"),i("2877")),P=Object(T["a"])(F,r,l,!1,null,"eb20566c",null),j=P.exports,I={name:"app",components:{MainView:j}},A=I,G=(i("fffb"),Object(T["a"])(A,a,o,!1,null,null,null)),K=G.exports;n["a"].config.productionTip=!1,n["a"].use(s["a"]),new n["a"]({render:function(e){return e(K)}}).$mount("#app")},a210:function(e,t,i){},d205:function(e,t,i){},d7af:function(e,t,i){e.exports=i.p+"430b576ef9e829f9068d.worklet.js"},fffb:function(e,t,i){"use strict";var n=i("a210"),s=i.n(n);s.a}});
//# sourceMappingURL=app.aefd1952.js.map